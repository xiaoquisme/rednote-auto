services:
  # Main application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      # Anthropic API (for Claude Code agents)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # Twitter
      - TWITTER_TARGET_USERNAMES=${TWITTER_TARGET_USERNAMES}
      # Agent settings
      - AGENT_MODEL=${AGENT_MODEL:-sonnet}
      - AGENT_MAX_TURNS=${AGENT_MAX_TURNS:-30}
      - AGENT_HEADLESS=${AGENT_HEADLESS:-true}
      # Database
      - DATABASE_URL=sqlite+aiosqlite:////app/data/posts.db
      # Inngest
      - INNGEST_APP_ID=${INNGEST_APP_ID:-rednote-auto}
      - INNGEST_IS_PRODUCTION=${INNGEST_IS_PRODUCTION:-false}
      - INNGEST_DEV_SERVER_URL=http://inngest:8288
    volumes:
      # Persist data
      - ./data:/app/data
    depends_on:
      - inngest
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Inngest Dev Server (for development)
  inngest:
    image: inngest/inngest:latest
    ports:
      - "8288:8288"
    command: ["inngest", "dev", "-u", "http://app:8000/api/inngest"]
    restart: unless-stopped
